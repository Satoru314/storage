# 画像ファイルアップロード処理 詳細設計

## システム概要

指定された構成（SPA + アプリケーション・DBサーバー + S3）において、画像ファイルのアップロード機能を実現する。フロントエンドからS3への直接アップロード方式を採用し、サーバー負荷を軽減する。

**基本フロー**:
1. ユーザーがファイルを選択
2. フロントエンドがバックエンドにアップロード要求
3. バックエンドがS3のpresigned URLを生成
4. フロントエンドがS3に直接アップロード
5. 完了後、バックエンドにステータス更新を通知

## バックエンドエンドポイント

### POST /images/upload-request
アップロード用presigned URL取得

```
Request:
{
  "fileName": "example.jpg",
  "contentType": "image/jpeg",
  "fileSize": 1048576
}

Response:
{
  "imageId": "uuid",
  "objectKey": "2024/08/24/uuid_example.jpg",
  "uploadUrl": "https://s3-presigned-url...",
  "uploadMethod": "PUT",
  "headers": {
    "Content-Type": "image/jpeg"
  },
  "expiresIn": 300
}
```

### POST /images/upload-complete
アップロード完了通知

```
Request:
{
  "imageId": "uuid",
  "objectKey": "2024/08/24/uuid_example.jpg"
}

Response:
{
  "status": "success"
}
```

### GET /images
画像一覧取得

```
Response:
{
  "images": [
    {
      "id": "uuid",
      "originalName": "example.jpg",
      "objectKey": "2024/08/24/uuid_example.jpg",
      "fileSize": 1048576,
      "uploadedAt": "2024-08-24T10:00:00Z"
    }
  ]
}
```

### POST /images/view-urls
表示用presigned URL取得

```
Request:
{
  "imageIds": ["uuid1", "uuid2"]
}

Response:
{
  "urls": [
    {
      "imageId": "uuid1",
      "url": "https://s3-presigned-url-for-get...",
      "expiresAt": "2024-08-24T10:05:00Z"
    }
  ]
}
```

## フロントエンド設計

フロントエンドでは、ファイル選択からアップロード完了までの一連のイベントを適切にハンドリングし、ユーザーに分かりやすいフィードバックを提供する。

### イベント処理フロー

**1. ファイル選択イベント**
```javascript
const handleFileSelect = (event) => {
  const file = event.target.files[0];
  setSelectedFile(file);
  setUploadState('selected');
}
```

**2. アップロード開始イベント**
```javascript
const handleUploadStart = async () => {
  setUploadState('requesting');
  
  try {
    // Step 1: アップロード要求
    const uploadRequest = await fetch('/api/images/upload-request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        fileName: selectedFile.name,
        contentType: selectedFile.type,
        fileSize: selectedFile.size
      })
    }).then(res => res.json());

    setUploadState('uploading');

    // Step 2: S3直接アップロード
    await fetch(uploadRequest.uploadUrl, {
      method: uploadRequest.uploadMethod,
      headers: uploadRequest.headers,
      body: selectedFile
    });

    setUploadState('completing');

    // Step 3: 完了通知
    await fetch('/api/images/upload-complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        imageId: uploadRequest.imageId,
        objectKey: uploadRequest.objectKey
      })
    });

    setUploadState('success');
    refreshImageList();

  } catch (error) {
    setUploadState('error');
    setErrorMessage(error.message);
  }
}
```

**3. 画像一覧取得**
```javascript
const fetchImages = async () => {
  const response = await fetch('/api/images');
  const data = await response.json();
  setImages(data.images);
  
  // 表示用URL取得
  const imageIds = data.images.map(img => img.id);
  const urlResponse = await fetch('/api/images/view-urls', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ imageIds })
  });
  const urlData = await urlResponse.json();
  setImageUrls(urlData.urls);
}
```

### 状態管理

アップロード処理の各段階でUIの状態を適切に管理し、ユーザーに進行状況を表示する。

```javascript
const [uploadState, setUploadState] = useState('idle');
// 'idle' | 'selected' | 'requesting' | 'uploading' | 'completing' | 'success' | 'error'

const [selectedFile, setSelectedFile] = useState(null);
const [images, setImages] = useState([]);
const [imageUrls, setImageUrls] = useState([]);
const [errorMessage, setErrorMessage] = useState('');
```

## データベース設計

画像のメタデータを管理するためのテーブル設計。upload_statusでアップロード状態を追跡し、データ整合性を保つ。

```sql
CREATE TABLE images (
    id UUID PRIMARY KEY,
    object_key VARCHAR(512) UNIQUE NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    file_size BIGINT NOT NULL,
    upload_status VARCHAR(20) NOT NULL DEFAULT 'requested',
    created_at TIMESTAMP DEFAULT NOW(),
    uploaded_at TIMESTAMP,
    INDEX idx_upload_status (upload_status),
    INDEX idx_created_at (created_at)
);
```